<services>
    <service verb="create" noun="userAccount">   
        <in-parameters>
            <parameter name="firstName" required="true"/>
            <parameter name="lastName" required="true"/>
            <parameter name="username" required="true"/>
            <parameter name="newPassword" required="true"/>
            <parameter name="newPasswordVerify" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="partyId"/>
        </out-parameters>
        <actions>
            <script>
                EntityValue queryForUsername = ec.entity.find("mantle.party.PersonAndUserAccount").condition( [ "username" : username ] ).one()
            </script>

            <if condition="queryForUsername != null">
                <return error="true" message="There is already an account with this email address."/>
            </if>

            <if condition="queryForUsername == null">
                <service-call name="mantle.party.PartyServices.create#PersonCustomer" in-map="[partyId:partyId] + context" out-map="context"/>
                <service-call name="mantle.party.PartyServices.create#PartyUserAccount" in-map="[partyId:partyId, emailAddress:username, userGroupId:'ADMIN'] + context" out-map="context"/>
            </if>

            <script>
                println "-------------------create user account-------------------------"
                println context
            </script>
        </actions>
    </service>

    <service verb="store" noun="PartyContact">
        <in-parameters>
            <parameter name="organizationName" required="true"/>
            <parameter name="contactNumber" required="true"/>
            <parameter name="address1" required="true"/>
            <parameter name="address2"/>
            <parameter name="postalCode" required="true"/>
            <parameter name="city" required="true"/>
            <parameter name="stateProvinceGeoId" required="true"/>
        </in-parameters>
        <out-parameters>
            <parameter name="partyId"/>
        </out-parameters>
        <actions>
            <script>
                EntityValue queryForOrganizationName = ec.entity.find("mantle.party.Organization").condition( [ "organizationName" : organizationName ] ).one()
            </script>

            <if condition="queryForOrganizationName != null">
                <return error="true" message="Organization already exists"/>
            </if>

            <if condition="queryForOrganizationName == null">
                <service-call name="create#mantle.party.Organization" in-map="context" out-map="context"/>
            </if>

            <service-call name="mantle.party.ContactServices.store#PartyContactInfo" in-map="[partyId:partyId] + context" out-map="context"/>

            <script>
                println "-------------------store party contact-------------------------"
                println context
                println partyId
            </script>
        </actions>
    </service>



    <service verb="create" noun="PaymentMethod">
        <in-parameters>
            <parameter name="description"/>
            <parameter name="typeEnumId"/>
            <parameter name="firstNameOnAccount"/>
            <parameter name="lastNameOnAccount"/>
            <parameter name="routingNumber"/>
            <parameter name="accountNumber"/>
        </in-parameters>
        <actions>
            <service-call name="mantle.account.PaymentMethodServices.create#BankAccount" in-map="[ownerPartyId:partyId] + context" out-map="context"/>
            <script>
                println "-------------------create payment method-------------------------"
                println context
            </script>
        </actions>
    </service>

</services> 